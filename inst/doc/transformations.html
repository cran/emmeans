<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Russ Lenth" />

<meta name="date" content="2018-01-09" />

<title>Transformations and link functions in emmeans</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Transformations and link functions in emmeans</h1>
<h4 class="author"><em>Russ Lenth</em></h4>
<h4 class="date"><em>2018-01-09</em></h4>



<div id="contents" class="section level2">
<h2>Contents</h2>
<p>This vignette covers the intricacies of transformations and link functions in <strong>emmeans</strong>.</p>
<ol style="list-style-type: decimal">
<li><a href="#timing">Overview</a></li>
<li><a href="#regrid">Re-gridding</a></li>
<li><a href="#links">Link functions</a></li>
<li><a href="#tranlink">Both a response transformation and a link</a></li>
<li><a href="#special">Special transformations</a></li>
<li><a href="#after">Specifying a transformation after the fact</a></li>
<li><a href="#logs">Faking a log transformation</a></li>
</ol>
<p><a href="index.html">Vignette index</a></p>
</div>
<div id="timing" class="section level2">
<h2>Overview</h2>
<p>Consider the same example with the <code>pigs</code> dataset that is used in many of these vignettes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pigs.lm &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">log</span>(conc) <span class="op">~</span><span class="st"> </span>source <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(percent), <span class="dt">data =</span> pigs)</code></pre></div>
<p>This model has two factors, <code>source</code> and <code>percent</code> (coerced to a factor), as predictors; and log-transformed <code>conc</code> as the response. Here we obtain the EMMs for <code>source</code>, examine its structure, and finally produce a summary, including a test against a null value of log(35):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pigs.emm.s &lt;-<span class="st"> </span><span class="kw">emmeans</span>(pigs.lm, <span class="st">&quot;source&quot;</span>)
<span class="kw">str</span>(pigs.emm.s)
## 'emmGrid' object with variables:
##     source = fish, soy, skim
## Transformation: &quot;log&quot;

<span class="kw">summary</span>(pigs.emm.s, <span class="dt">infer =</span> <span class="ot">TRUE</span>, <span class="dt">null =</span> <span class="kw">log</span>(<span class="dv">35</span>))
##  source   emmean         SE df lower.CL upper.CL     null t.ratio p.value
##  fish   3.394492 0.03668122 23 3.318612 3.470373 3.555348  -4.385  0.0002
##  soy    3.667260 0.03744798 23 3.589793 3.744727 3.555348   2.988  0.0066
##  skim   3.796770 0.03938283 23 3.715300 3.878240 3.555348   6.130  &lt;.0001
## 
## Results are averaged over the levels of: percent 
## Results are given on the log (not the response) scale. 
## Confidence level used: 0.95</code></pre></div>
<p>Now suppose that we want the EMMs expressed on the same scale as <code>conc</code>. This can be done by adding <code>type = &quot;response&quot;</code> to the <code>summary()</code> call:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(pigs.emm.s, <span class="dt">infer =</span> <span class="ot">TRUE</span>, <span class="dt">null =</span> <span class="kw">log</span>(<span class="dv">35</span>), <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
##  source response       SE df lower.CL upper.CL null t.ratio p.value
##  fish   29.79952 1.093083 23 27.62197 32.14874   35  -4.385  0.0002
##  soy    39.14451 1.465883 23 36.22658 42.29747   35   2.988  0.0066
##  skim   44.55704 1.754782 23 41.07093 48.33905   35   6.130  &lt;.0001
## 
## Results are averaged over the levels of: percent 
## Confidence level used: 0.95 
## Intervals are back-transformed from the log scale 
## Tests are performed on the log scale</code></pre></div>
<div id="timing-is-everything" class="section level3">
<h3>Timing is everything</h3>
<p>Dealing with transformations in <strong>emmeans</strong> is somewhat complex, due to the large number of possibilities. But the key is understanding what happens, when. These results come from a sequence of steps. Here is what happens (and doesn’t happen) at each step:</p>
<ol style="list-style-type: decimal">
<li>The reference grid is constructed for the <code>log(conc)</code> model. The fact that a log transformation is used is recorded, but nothing else is done with that information.</li>
<li>The predictions on the reference grid are averaged over the four <code>percent</code> levels, for each <code>source</code>, to obtain the EMMs for <code>source</code> – <em>still</em> on the <code>log(conc)</code> scale.</li>
<li>The standard errors and confidence intervals for these EMMs are computed – <em>still</em> on the <code>log(conc)</code> scale.</li>
<li>Only now do we do back-transformation…
<ol style="list-style-type: lower-alpha">
<li>The EMMs are back-transformed to the <code>conc</code> scale.</li>
<li>The endpoints of the confidence intervals are back-transformed.</li>
<li>The <em>t</em> tests and <em>P</em> values are left as-is.</li>
<li>The standard errors are converted to the <code>conc</code> scale using the delta method. These SEs were <em>not</em> used in constructing the tests and confidence intervals.</li>
</ol></li>
</ol>
</div>
<div id="the-model-is-our-best-guide" class="section level3">
<h3>The model is our best guide</h3>
<p>This choice of timing is based on the idea that <em>the model is right</em>. In particular, the fact that the response is transformed suggests that the transformed scale is the best scale to be working with. In addition, the model specifies that the effects of <code>source</code> and <code>percent</code> are <em>linear</em> on the transformed scale; inasmuch as marginal averaging to obtain EMMs is a linear operation, that averaging is best done on the transformed scale. For those two good reasons, back-transforming to the response scale is delayed until the very end by default.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>
<div id="regrid" class="section level2">
<h2>Re-gridding</h2>
<p>As well-advised as it is, some users may not want the default timing of things. The tool for changing when back-transformation is performed is the <code>regrid()</code> function – which, with default settings of its arguments, back-transforms an <code>emmGrid</code> object and adjusts everything in it appropriately. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">regrid</span>(pigs.emm.s))
## 'emmGrid' object with variables:
##     source = fish, soy, skim

<span class="kw">summary</span>(<span class="kw">regrid</span>(pigs.emm.s), <span class="dt">infer =</span> <span class="ot">TRUE</span>, <span class="dt">null =</span> <span class="dv">35</span>)
##  source response       SE df lower.CL upper.CL null t.ratio p.value
##  fish   29.79952 1.093083 23 27.53831 32.06074   35  -4.758  0.0001
##  soy    39.14451 1.465883 23 36.11210 42.17692   35   2.827  0.0096
##  skim   44.55704 1.754782 23 40.92699 48.18708   35   5.446  &lt;.0001
## 
## Results are averaged over the levels of: percent 
## Confidence level used: 0.95</code></pre></div>
<p>Notice that the structure no longer includes the transformation. That’s because it is no longer relevant; the reference grid is on the <code>conc</code> scale, and how we got there is now forgotten. Compare this <code>summary()</code> result with the preceding one, and note the following:</p>
<ul>
<li>It no longer has annotations concerning transformations.</li>
<li>The estimates and SEs are identical.</li>
<li>The confidence intervals, <em>t</em> ratios, and <em>P</em> values are <em>not</em> identical. This is because, this time, the SEs shown in the table are the ones actually used to construct the tests and intervals.</li>
</ul>
<p>Understood, right? But think carefully about how these EMMs were obtained. They are back-transformed from <code>pigs.emm.s</code>, in which <em>the marginal averaging was done on the log scale</em>. If we want to back-transform <em>before</em> doing the averaging, we need to call <code>regrid()</code> after the reference grid is constructed but before the averaging takes place:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pigs.rg &lt;-<span class="st"> </span><span class="kw">ref_grid</span>(pigs.lm)
pigs.remm.s &lt;-<span class="st"> </span><span class="kw">emmeans</span>(<span class="kw">regrid</span>(pigs.rg), <span class="st">&quot;source&quot;</span>)
<span class="kw">summary</span>(pigs.remm.s, <span class="dt">infer =</span> <span class="ot">TRUE</span>, <span class="dt">null =</span> <span class="dv">35</span>)
##  source response       SE df lower.CL upper.CL null t.ratio p.value
##  fish   29.97478 1.096051 23 27.70743 32.24214   35  -4.585  0.0001
##  soy    39.37473 1.494655 23 36.28280 42.46666   35   2.927  0.0076
##  skim   44.81909 1.789918 23 41.11636 48.52182   35   5.486  &lt;.0001
## 
## Results are averaged over the levels of: percent 
## Confidence level used: 0.95</code></pre></div>
<p>These results all differ from either of the previous two summaries – again, because the averaging is done on the <code>conc</code> scale rather than the <code>log(conc)</code> scale.</p>
<p>Note: For those who want to routinely back-transform before averaging, the <code>transform</code> argument in <code>ref_grid()</code> simplifies this. The first two steps above could have been done more easily as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pigs.remm.s &lt;-<span class="st"> </span><span class="kw">emmeans</span>(pigs.lm, <span class="st">&quot;source&quot;</span>, <span class="dt">transform =</span> <span class="st">&quot;response&quot;</span>)</code></pre></div>
<p>But don’t get <code>transform</code> and <code>type</code> confused. The <code>transform</code> argument is passed to <code>regrid()</code> after the reference grid is constructed, whereas the <code>type</code> argument is simply remembered and used by <code>summary()</code>. So a similar-looking call:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">emmeans</span>(pigs.lm, <span class="st">&quot;source&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</code></pre></div>
<p>will compute the results we have seen for <code>pigs.emm.s</code> – back-transformed <em>after</em> averaging on the log scale.</p>
<p>Remember again: When it comes to transformations, timing is everything.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div id="section" class="section level1">
<h1></h1>
<div id="links" class="section level2">
<h2>Link functions</h2>
<p>Exactly the same ideas we have presented for response transformations apply to generalized linear models having non-identity link functions. As far as <strong>emmeans</strong> is concerned, there is no difference at all.</p>
<p>To illustrate, consider the <code>neuralgia</code> dataset provided in the package. These data come from an experiment reported in a SAS technical report where different treatments for neuralgia are compared. The patient’s sex is an additional factor, and their age is a covariate. The response is <code>Pain</code>, a binary variable on whether or not the patient reports neuralgia pain after treatment. The model suggested in the SAS report is equivalent to the following. We use it to obtain estimated probabilities of experiencing pain:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">neuralgia.glm &lt;-<span class="st"> </span><span class="kw">glm</span>(Pain <span class="op">~</span><span class="st"> </span>Treatment <span class="op">*</span><span class="st"> </span>Sex <span class="op">+</span><span class="st"> </span>Age, <span class="dt">family =</span> <span class="kw">binomial</span>(), <span class="dt">data =</span> neuralgia)
neuralgia.emm &lt;-<span class="st"> </span><span class="kw">emmeans</span>(neuralgia.glm, <span class="st">&quot;Treatment&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
## <span class="al">NOTE</span>: Results may be misleading due to involvement in interactions
neuralgia.emm
##  Treatment      prob         SE  df  asymp.LCL asymp.UCL
##  A         0.2109015 0.11090460 Inf 0.06750694 0.4966578
##  B         0.1206362 0.08352179 Inf 0.02848317 0.3909567
##  P         0.8662555 0.08827173 Inf 0.59265359 0.9664811
## 
## Results are averaged over the levels of: Sex 
## Confidence level used: 0.95 
## Intervals are back-transformed from the logit scale</code></pre></div>
<p>(The note about the interaction is discussed shortly.) Note that the averaging over <code>Sex</code> is done on the logit scale, <em>before</em> the results are back-transformed for the summary. We may use <code>pairs()</code> to compare these estimates; note that logits are logs of odds; so this is another instance where log-differences are back-transformed – in this case to odds ratios:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pairs</span>(neuralgia.emm, <span class="dt">reverse =</span> <span class="ot">TRUE</span>)
##  contrast odds.ratio         SE  df z.ratio p.value
##  B / A     0.5132877  0.5146063 Inf  -0.665  0.7837
##  P / A    24.2338121 25.1423051 Inf   3.073  0.0060
##  P / B    47.2129213 57.2422531 Inf   3.179  0.0042
## 
## Results are averaged over the levels of: Sex 
## P value adjustment: tukey method for comparing a family of 3 estimates 
## Tests are performed on the log odds ratio scale</code></pre></div>
<p>So there is evidence of considerably more pain being reported with placebo (treatment <code>P</code>) than with either of the other two treatments. The estimated odds of pain with <code>B</code> are about half that for <code>A</code>, but this finding is not statistically significant. (The odds that this is a made-up dataset seem quite high, but that finding is strictly this author’s impression.)</p>
<p>Observe that there is a note in the output for <code>neuralgia.emm</code> that the results may be misleading. It is important to take it seriously, because if two factors interact, it may be the case that marginal averages of predictions don’t reflect what is happening at any level of the factors being averaged over. To find out, look at an interaction plot of the fitted model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">emmip</span>(neuralgia.glm, Sex <span class="op">~</span><span class="st"> </span>Treatment)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>There is no practical difference between females and males in the patterns of response to <code>Treatment</code>; so I think most people would be quite comfortable with the marginal results that are reported earlier.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div id="tranlink" class="section level2">
<h2>Models having both a response transformation and a link function</h2>
<p>It is possible to have a generalized linear model with a non-identity link <em>and</em> a response transformation. Here is an example, with the built-in <code>wapbreaks</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">warp.glm &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="kw">sqrt</span>(breaks) <span class="op">~</span><span class="st"> </span>wool<span class="op">*</span>tension, <span class="dt">family =</span> Gamma, <span class="dt">data =</span> warpbreaks)
<span class="kw">ref_grid</span>(warp.glm)
## 'emmGrid' object with variables:
##     wool = A, B
##     tension = L, M, H
## Transformation: &quot;inverse&quot; 
## Additional response transformation: &quot;sqrt&quot;</code></pre></div>
<p>The canonical link for a gamma model is the reciprocal (or inverse); and there is the square-root response transformation besides. If we choose <code>type = &quot;response&quot;</code> in summarizing, we undo <em>both</em> transformations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">emmeans</span>(warp.glm, <span class="op">~</span><span class="st"> </span>tension <span class="op">|</span><span class="st"> </span>wool, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
## wool = A:
##  tension response       SE  df asymp.LCL asymp.UCL
##  L       42.87080 5.237067 Inf  33.22074  53.74966
##  M       23.28978 2.845066 Inf  18.04733  29.19978
##  H       23.58442 2.881055 Inf  18.27566  29.56919
## 
## wool = B:
##  tension response       SE  df asymp.LCL asymp.UCL
##  L       27.43817 3.351832 Inf  21.26193  34.40087
##  M       28.07575 3.429719 Inf  21.75599  35.20024
##  H       18.50894 2.261044 Inf  14.34264  23.20577
## 
## Confidence level used: 0.95 
## Intervals are back-transformed from the sqrt scale</code></pre></div>
<p>What happened here is first the linear predictor was back-transformed from the link scale (inverse); then the squares were obtained to back-transform the rest of the way. It is possible to undo the link, and not the response transformation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">emmeans</span>(warp.glm, <span class="op">~</span><span class="st"> </span>tension <span class="op">|</span><span class="st"> </span>wool, <span class="dt">type =</span> <span class="st">&quot;unlink&quot;</span>)
## wool = A:
##  tension response        SE  df asymp.LCL asymp.UCL
##  L       6.547580 0.3999238 Inf  5.847547  7.438013
##  M       4.825948 0.2947676 Inf  4.309983  5.482251
##  H       4.856380 0.2966258 Inf  4.337161  5.516819
## 
## wool = B:
##  tension response        SE  df asymp.LCL asymp.UCL
##  L       5.238146 0.3199445 Inf  4.678110  5.950505
##  M       5.298655 0.3236405 Inf  4.732150  6.019244
##  H       4.302202 0.2627775 Inf  3.842232  4.887278
## 
## Confidence level used: 0.95 
## Intervals are back-transformed from the inverse scale</code></pre></div>
<p>It is <em>not</em> possible to undo the response transformation and leave the link in place, because the response was transform first, then the link model was applied; we have to undo those in reverse order to make sense.</p>
<p>One may also use <code>&quot;unlink&quot;</code> as a <code>transform</code> argument in <code>regrid()</code> or through <code>ref_grid()</code>.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div id="special" class="section level2">
<h2>Special transformations</h2>
<p>The <code>make.tran()</code> function provides several special transformations and sets things up so they can be handled in <strong>emmeans</strong> with relative ease. (See [<code>help(&quot;make.tran&quot;, &quot;emmeans&quot;)](../html/make.tran.html) for descriptions of what is available.)</code>make.tran()<code>works much like</code>stats::make.link()<code>in that it returns a list of functions</code>linkfun()<code>,</code>linkinv()<code>, etc. that serve in managing results on a transformed scale. The difference is that most  transformations with</code>make.tran()` require additional arguments.</p>
<p>To use this capability in <code>emmeans()</code>, it is fortuitous to first obtain the <code>make.tran()</code> result, and then to use it as the enclosing environment for fitting the model, with <code>linkfun</code> as the transformation. For example, suppose we want to use the response transformation <span class="math inline">\(\log(y + \frac12)\)</span>. Then proceed like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tran &lt;-<span class="st"> </span><span class="kw">make.tran</span>(<span class="st">&quot;genlog&quot;</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>)
my.model &lt;-<span class="st"> </span><span class="kw">with</span>(tran, 
    <span class="kw">lmer</span>(<span class="kw">linkfun</span>(yield) <span class="op">~</span><span class="st"> </span>treatment <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Block), <span class="dt">data =</span> mydata))</code></pre></div>
<p>Subsequent calls to <code>ref_grid()</code>, <code>emmeans()</code>, <code>regrid()</code>, etc. will then be able to access the transformation information correctly.</p>
<p>The help page for <code>make.tran()</code> has an example like this using a Box-Cox transformation.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div id="after" class="section level2">
<h2>Specifying a transformation after the fact</h2>
<p>It is not at all uncommon to fit a model using statements like the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mydata &lt;-<span class="st"> </span><span class="kw">transform</span>(mydata, <span class="dt">logy.5 =</span> <span class="kw">log</span>(yield <span class="op">+</span><span class="st"> </span>.<span class="dv">5</span>))
my.model &lt;-<span class="st"> </span><span class="kw">lmer</span>(logy.<span class="dv">5</span> <span class="op">~</span><span class="st"> </span>treatment <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Block), <span class="dt">data =</span> mydata)</code></pre></div>
<p>In this case, there is no way for <code>ref_grid()</code> to figure out that a response transformation was used. What can be done is to update the reference grid with the required information:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my.rg &lt;-<span class="st"> </span><span class="kw">update</span>(<span class="kw">ref_grid</span>(my.model), <span class="dt">tran =</span> <span class="kw">make.tran</span>(<span class="st">&quot;genlog&quot;</span>, .<span class="dv">5</span>))</code></pre></div>
<p>Subsequently, use <code>my.rg</code> in place of <code>my.mnodel</code> in any <code>emmeans()</code> analyses, and the transformation information will be there.</p>
<p>For standard transformations (those in <code>stats::make.link()</code>), just give the name of the transformation; e.g.,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model.rg &lt;-<span class="st"> </span><span class="kw">update</span>(<span class="kw">ref_grid</span>(model), <span class="dt">tran =</span> <span class="st">&quot;sqrt&quot;</span>)</code></pre></div>
<p><a href="#contents">Back to Contents</a></p>
</div>
<div id="logs" class="section level2">
<h2>Faking a log transformation</h2>
<p>The <code>regrid()</code> function makes it possible to fake a log transformation of the response. Why would you want to do this? So that you can make comparisons using ratios instead of differences.</p>
<p>Consider the <code>pigs</code> example once again, but suppose we had fitted a model with a square-root transformation instead of a log:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pigroot.lm &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">sqrt</span>(conc) <span class="op">~</span><span class="st"> </span>source <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(percent), <span class="dt">data =</span> pigs)
piglog.emm.s &lt;-<span class="st"> </span><span class="kw">regrid</span>(<span class="kw">emmeans</span>(pigroot.lm, <span class="st">&quot;source&quot;</span>), <span class="dt">transform =</span> <span class="st">&quot;log&quot;</span>)
<span class="kw">confint</span>(piglog.emm.s, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
##  source response       SE df lower.CL upper.CL
##  fish   29.84382 1.316416 23 27.24115 32.69514
##  soy    39.24300 1.541103 23 36.18104 42.56408
##  skim   44.99895 1.735523 23 41.54824 48.73626
## 
## Results are averaged over the levels of: percent 
## Confidence level used: 0.95 
## Intervals are back-transformed from the log scale
<span class="kw">pairs</span>(piglog.emm.s, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
##  contrast        ratio         SE df t.ratio p.value
##  fish / soy  0.7604877 0.04535114 23  -4.591  0.0004
##  fish / skim 0.6632114 0.03910379 23  -6.965  &lt;.0001
##  soy / skim  0.8720869 0.04685060 23  -2.548  0.0457
## 
## Results are averaged over the levels of: percent 
## P value adjustment: tukey method for comparing a family of 3 estimates 
## Tests are performed on the log scale</code></pre></div>
<p>These results are not identical, but very similar to the back-transformed confidence intervals <a href="#timing">above</a> for the EMMs and the <a href="comparisons.html#logs">pairwise ratios in the “comparisons” vignette</a>, where the fitted model actually used a log response.</p>
<p><a href="#contents">Back to Contents</a></p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
